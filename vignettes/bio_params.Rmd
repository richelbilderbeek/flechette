---
title: "Choosing The Biological Parameters"
author: "Richel J.C. Bilderbeel"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Choosing The Biological Parameters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Goal

To create a set of biological parameters.

Instead of starting from the speciation
initiation and speciation completion rate, we start from:

 * the expected mean number of species must be 50, 100 and 200
 * the extinction rates are 0.3 and 0.5
 

```{r}
df <- data.frame(
  er = rep(c(0.3, 0.5), each = 3),
  n = rep(c(50, 100, 200), times = 2)
)
df$sir <- "?"
df$scr <- "?"
knitr::kable(df)
```

## Setup

Some libraries we need:

```{r}
library(ggplot2)
```
To limit the computational time, we pick relatively small numbers of species:

```{r}
ns <- c(50, 100, 200)
```

Following Etienne & Rosindell, we use these extinction rates:

```{r}
ers <- c(0.3, 0.5)
```

Following Etienne & Rosindell, we use this crown age:

```{r}
crown_age <- 15
```

## Find the speciation rate in the BD model

In the BD model, the speciation completion rate is close to infinite:

```{r}
scr <- 10e9 # close to infinite
```

To get an idea, plot the number of species for the speciation and extinction rates:

```{r fig.width=7}
n_points <- 11
df <- data.frame(
  sir = rep(seq(0.4, 0.8, length.out = n_points), each = n_points),  
  er = rep(seq(0.2, 0.6, length.out = n_points), times = n_points)
)
df$n <- PBD::pbd_numspec_mean_checked(
  ergs = df$er, 
  eris = df$er, 
  scr = rep(scr, nrow(df)), 
  sirs = df$sir, 
  crown_ages = rep(crown_age, nrow(df))
)
plot_bd <- ggplot(df, aes(sir, er, z = n)) + 
  geom_raster(aes(fill = n)) + 
  scale_fill_gradientn(colours=c("white","blue")) +
  geom_contour(breaks = ns, color = "green") +
  geom_hline(yintercept = ers, color = "red")
plot_bd
```

The points where the red and green lines cross are the speciation rates
we are looking for. We'd like to fill this data frame:

```{r}
df_bd <- data.frame(
  er = rep(ers, each = 3),
  n = rep(ns, times = 2)
)
df_bd$sir <- rep("?", nrow(df_bd))
knitr::kable(df_bd)
```

From these, we can calculate the speciation rates for a BD model:

```{r}
# The difference between the mean number of species as produced by the
# BD model and the desired number of species
sir_error <- function(sir, known_er, known_scr, known_crown_age, n_desired) {
  PBD::pbd_numspec_mean_checked( 
    ergs = known_er, 
    eris = known_er, 
    scrs = known_scr, 
    sirs = sir,
    crown_age = known_crown_age
  ) - n_desired
}

for (row in seq_along(df_bd$sir)) {
  er <- df_bd$er[row]
  n <- df_bd$n[row]
  f <- functional::Curry(
    sir_error,
    known_er = er, 
    known_scr = scr, 
    known_crown_age = crown_age,
    n_desired = n
  )
  df_bd$sir[row] <- uniroot(f, interval = c(0.4, 0.8))$root
}
knitr::kable(df_bd)
```

Verify if we correctlt calculated the speciation initiation rates in the plot:

```{r fig.width=7}
plot_bd + geom_point(data = df_bd, aes(x = as.numeric(sir), y = as.numeric(er)))
````
We just found the speciation initiation rates we need for a BD model.

